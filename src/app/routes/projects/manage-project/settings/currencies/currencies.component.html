<div class="container-fluid project-currency-conversion-page">

  <form class="form-horizontal" [formGroup]="currenciesForm" novalidate>
    <div class="row no-mg">

      <div class="col-md-12 no-mg">
        <div class="panel panel-primary">
          <div class="panel-body">
            <ng-container *ngIf="showLoadingFlg;else showForm">
              <app-loader class="col-md-12" [loading]="showLoadingFlg"></app-loader>
            </ng-container>
            <ng-template #showForm>
              <div class="row container">
                <div class="col-md-10">
                  <table class="table ml-2 text-center">
                    <thead>
                      <tr>

                        <th>{{'projects.labels.sourceCurrency'| translate}}</th>
                        <th>{{'projects.labels.unit'| translate}}</th>
                        <th>{{'projects.labels.targetCurrency'| translate}}</th>
                        <th>{{'projects.labels.conversionRate'| translate}}</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container formArrayName="currencyConversionArr">
                        <tr
                          *ngFor="let row of currenciesForm.controls.currencyConversionArr['controls']; let i=index;let lst=last;let first=first">
                          <ng-container [formGroupName]="i">
                            <td>{{ row?.value?.sourceCode}}</td>
                            <td>{{ row?.value?.sourceUnit}}</td>
                            <td>
                              <div>
                                <div *ngIf="row?.value?.isEditable;else showCurrencyLabel">
                                  <ngx-select [items]="row?.value?.currencies" [allowClear]="true"
                                    formControlName="targetCurrencyId" (select)="currencyChanged($event)">
                                  </ngx-select>
                                </div>

                                <ng-template #showCurrencyLabel>
                                  <span>{{ row?.value?.targetCode}}</span>
                                </ng-template>
                                <div class="text-danger text-left"
                                  *ngIf="row.controls['targetCurrencyId']?.errors?.checkRequired && (row.controls['targetCurrencyId'].touched || submmitedFormFlag)">
                                  {{'pages.errorMessages.fieldRequired'| translate}}</div>
                              </div>
                            </td>
                            <td>
                              <div>
                                <input *ngIf="row?.value?.isEditable;else showUnitLabel" class="form-control"
                                  oninput="this.value = this.value.replace(/[^0-9.]/g,'');" formControlName="targetUnit"
                                  type="text" (change)="checkRate(row)">
                                <div class="text-danger text-left"
                                  *ngIf="row.controls['targetUnit']?.errors?.checkRequired && (row.controls['targetUnit'].touched || submmitedFormFlag)">
                                  {{'pages.errorMessages.fieldRequired'| translate}}</div>
                                <div class="text-danger"
                                  *ngIf="!row.controls['targetUnit']?.errors?.checkRequired && row.controls['targetUnit']?.errors?.checkDecimal && (row.controls['targetUnit'].touched) && row.controls['targetUnit'].dirty">
                                  {{'pages.errorMessages.validDecimal'| translate}}</div>
                              </div>
                              <ng-template #showUnitLabel>
                                <span>{{ row?.value?.targetUnit}}</span>
                              </ng-template>
                            </td>
                            <td>
                              <div class="col-md-12 col-xs-12 col-sm-12 add-minus">
                                <a (click)="addRow(row,i)" class="click-cursor ml-2"
                                  *ngIf="lst && (currenciesForm?.value?.currencyConversionArr?.length > 0) && (currencies?.length!=currenciesForm?.value?.currencyConversionArr?.length)">
                                  <i class="fa fa-plus"></i>
                                </a>
                              </div>
                            </td>
                          </ng-container>
                        </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>
              </div>
            </ng-template>
          </div>
        </div>
        <div class="col-md-12 mt-3 no-mg">
          <action-permission [permissionArr]="permissionObj" [MODULE_ID]="MODULE_ID" [actionType]="ACTION_TYPES.EDIT">

            <button (click)="updateCurrencyConversions()" [disabled]="isClicked || showLoadingFlg"
              class="btn btn-success save-btn"><i *ngIf="spinnerFlag"
                class="fa fa-spinner fa-spin margin-right-5"></i>{{'common.labels.save'| translate}}</button>
          </action-permission>
          <button (click)="navigateTo()"
            class="btn btn-danger ml-1 cancel-btn">{{'common.labels.cancel'| translate}}</button>

        </div>
      </div>
    </div>
  </form>

</div>
